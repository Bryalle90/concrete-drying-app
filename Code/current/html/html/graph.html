<!--
Author: Daniel Grote
file - graph.html

Desc: This file generates the graph
-->

<div class="bs-example">
	<div class="alert alert-success" id='notifSuccess' role="alert" align="center" hidden="true">
		<a href="#" class="close" >&times;</a>
		<strong>Success!</strong> Your notification has successfully been saved.
	</div>
</div>
<div class="bs-example">
	<div class="alert alert-success" id='emailSuccess' role="alert" align="center" hidden="true">
		<a href="#" class="close">&times;</a>
		<strong>Success!</strong> Your E-mail has succesfully been sent.
	</div>
</div>

<?php
if(isset($_POST['projectID']))
{
	?>
	<script> var isProject = true;</script>
	
	<?php
	include($_SERVER['DOCUMENT_ROOT'].'/classes/DbProject.php');
	include($_SERVER['DOCUMENT_ROOT'].'/classes/DbUser.php');
	$projectID = $_POST['projectID'];
	$projectdb= new DbProject();
	$userdb = new DbUser();
	$userID = $_SESSION['id'];
	
	if($projectdb->getOwner($projectID) == $userID)
	{
		$isOwner = true;
		if ($userdb->getSeenNotificationMsg($userID) == 0)
		{
		?>
		<div class="alert alert-info" id ='notifInfo' role="alert" align="center">
			<a href="#" class="close">&times;</a>Click a point to add a notification<br>
			<input type="checkbox" name="checkbox" id='checkbox' value="0" onclick=<?php $userdb->seenNotificationMsg($userID); ?>> Check this box to never display this message 
		</div>
		<?php
		}
	}
	
	else
	{
		$isOwner = false;
	}
	
	$name = $projectdb->getName($_POST['projectID']);
	?>
	<script>
	var projectID = (<?php echo json_encode($projectID)?>);
	var projectName = (<?php echo json_encode($name)?>);
	var isOwner = (<?php echo json_encode($isOwner)?>);
	var userID = (<?php echo json_encode($userID)?>);
	//var yLevel = 30;
	var yLevel = 15;
	</script>
	<?php
}
else
{
	?>
	<script>
	var isProject = false;
	var projectName = null;
	var yLevel = 5;
	var isOwner = false;
	</script>
	<?php
}
?>

<div id="report"></div>

<!--Container that the chart is in -->
<div id="container" style="height:70vh; min-height:400px; min-width: 1050px;"></div>

<script>
	var currentZone;
	var notifTimeID;
	var seriesNotifID;
	var coldWeatherConcTemp = 49;
	var hotWeatherConcTemp = 85;
	var numberOfSeries = 1;
	var concTempArray = main.getConcreteTempArray();
	var cTempOffset = null;
	var windOffset = null;
	var city = main.getCity();
	var state = main.getState();
	var resetButton = false;
	var plotBandUpperBoundary = 5.0000;
	var plotBandRedYellowBoundary = 0.2001;
	var plotBandYellowGreenBoundary = 0.1501
	var plotBandLowerBoundary = -5.0000
	var ModerateRiskBoundary = 0.20;
	var lowRiskBoundary = 0.15;
	
$(function () {
	
	//Weather Data Arrays
	var evapArray = main.getEvapArray();
	var originalEvapArray = evapArray;
	var airTempArray = main.getAirTempArray();
	var userConcreteTempArray = {};
	var humidityArray = main.getHumidityArray();
	var timeArray = main.getTimeArray();
	var cloudCoverArray = main.getCloudCoverArray();
	var windSpeedArray = main.getWindSpeedArray();
	var originalWindSpeedArray = windSpeedArray;
	var zipCode = main.getZipCode();
	var isMetric = main.isMetric();	
	var arrayLength = evapArray.length;
	var isOrignalGraph = true;

	
	//These colors are used for the plotbands and tooltip borders
	var red = 'rgba(255, 0, 0, 0.8)';
	var yellow = 'rgba(255,255,0,.85)';
	var green = 'rgba(0, 226, 0, 0.7)';
	var tmpColor = ''

	var lowerBoundConcreteTemp = '';
	var upperBoundConcreteTemp = '';
	var lowerBoundWindSpeed = '';
	var upperBoundWindSpeed = '';
	
	var pointsSelected = [];
	var insideWindSpeed = []
	
	//Date and time variables
	var monthname = new Array();
	monthname[0] = "January";
	monthname[1] = "February";
	monthname[2] = "March";
	monthname[3] = "April";
	monthname[4] = "May";
	monthname[5] = "June";
	monthname[6] = "July";
	monthname[7] = "August";
	monthname[8] = "September";
	monthname[9] = "October";
	monthname[10] = "November";
	monthname[11] = "December";
	
	var weekday = new Array(7);
	weekday[0] = "Sun";
	weekday[1] = "Mon";
	weekday[2] = "Tues";
	weekday[3] = "Wed";
	weekday[4] = "Thur";
	weekday[5] = "Fri";
	weekday[6] = "Sat";
	
	var year = [];
	var day = [];
	var hour = [];
	var month = [];
	var nameOfMonth = [];
	var nameOfDay = [];

	//Labels
	var yaxislabel = "Evaporation Rate";
	var evaporationRateLabel = "";
	var temperatureLabel = "";
	var windLabel = "";

	var subtitle = city + ', ' + state + ' ' + zipCode;
	if (isProject) {
		if(projectName){
			var title = projectName;
		}
		else{
			var title = subtitle;
		}
	}
	else{
		var title = subtitle;
		var subtitle = '';
	}
	
	//Add suffixes of labels 
	//If metric assign metric labels
	if (isMetric)
	{
		yaxislabel += " (kg/m\xB2/hr)";
		evaporationRateLabel = ' kg/m'+'\xB2'+'/hr</b>';
		temperatureLabel = '\xB0'+'C';
		windLabel = 'kph';
		lowerBoundConcreteTemp = 4.4;
		upperBoundConcreteTemp = 37.2;
		lowerBoundWindSpeed = 0.0;
		upperBoundWindSpeed = 56.3;
		
		for (i = 0; i< arrayLength; i++)
		{
			insideWindSpeed[i] = 1.61;
		}
	}

	//else standard
	else
	{
		yaxislabel += " (lb/ft\xB2/hr)";
		evaporationRateLabel = ' lb/ft'+'\xB2'+'/hr </b> ';
		temperatureLabel = '\xB0'+'F';
		windLabel = 'mph';
		lowerBoundConcreteTemp = 40.0;
		upperBoundConcreteTemp = 130.0;
		lowerBoundWindSpeed = 0.0;
		upperBoundWindSpeed = 54.4;
		
		for (i = 0; i< arrayLength; i++)
		{
			insideWindSpeed[i] = 1;
		}
	}
	
	document.getElementById("concreteTemp").min = lowerBoundConcreteTemp;
	document.getElementById("concreteTemp").max = upperBoundConcreteTemp;
	document.getElementById("cTempLabel").innerHTML = temperatureLabel;

	//Format dates and times
	for (var i=0; i<arrayLength; i++)
	{
		var string = timeArray[i];
		var partsArray = string.split('-');
		year[i] = partsArray[0];
		month[i] = partsArray[1];
		day[i] = partsArray[2];
		hour[i] = partsArray[3];
		var d = new Date(partsArray[0], ((partsArray[1]) - 1), partsArray[2], partsArray[3], 0, 0, 0);
		year[i] = d.getFullYear().toString().substr(2,2);
		nameOfMonth[i] = monthname[d.getMonth()];
		nameOfDay[i] = weekday[d.getDay()];
	}
	
	var timezone = 'Local time of ' + city + ', ' + state + '<br>' +  nameOfMonth[0] + " " + day[0] + " - "+ nameOfMonth[nameOfMonth.length - 1] + " " + day[day.length - 1];

	//Labels for x-axis
	var labelDate = [];
	var fullDate = [];
	groupedLabels = [];
	d = []
	var j=0;
	var x=0;
	dayName = [];
	dayName[0] = nameOfDay[0];
	var zero = [];
	var one = [];
	var two = [];
	var three = [];
	var four = [];
	var five = [];
	var six = [];
	var seven = [];
	zero[0] = hour[0];
	
	//Set Labels for x-axis
	fullDate[0] = nameOfDay[0] + " " + nameOfMonth[0] + " " + day[0] + " at " + hour[0] + ":00";
	labelDate[0] = hour[0] +", "+ nameOfDay[0];
	
	for (var i = 1; i < arrayLength; i++)
	{
		fullDate[i] = nameOfDay[i] + " " + nameOfMonth[i] + " " + day[i] + " at " + hour[i] + ":00";
		labelDate[i] = hour[i] +", "+ nameOfDay[i];
	
		if (nameOfDay[i] == nameOfDay[i-1])
		{
			x += 1;
			if (j == 0) { zero[x] = hour[i]; }
			if (j == 1) { one[x] = hour[i]; }
			if (j == 2) { two[x] = hour[i]; }
			if (j == 3) { three[x] = hour[i]; }
			if (j == 4) { four[x] = hour[i]; }
			if (j == 5) { five[x] = hour[i]; }
			if (j == 6) { six[x] = hour[i]; }
			if (j == 7) { seven[x] = hour[i]; }
		}
		
		else
		{
			x = 0;
			j += 1;
			if (j == 0) { zero[0] = hour[i]; }
			if (j == 1) { one[0] = hour[i]; }
			if (j == 2) { two[0] = hour[i]; }
			if (j == 3) { three[0] = hour[i]; }
			if (j == 4) { four[0] = hour[i]; }
			if (j == 5) { five[0] = hour[i]; }
			if (j == 6) { six[0] = hour[i]; }
			if (j == 7) { seven[0] = hour[i]; }
			dayName[j] = nameOfDay[i]; 
		}
	}

	//Chart Configuration
	$('#container').highcharts
	({
		chart:
		{
		
		},
		
		//title configuration
		title: 
		{
			text: title,
			 x: -40 //center
		},

		//Subtitle configuration
		subtitle:
		{
			text: subtitle,
			x: -40 //center
		},

		//Legend configuration OFF
		legend:
		{
			title:
			{
				text: 'Predictions<br/><span style="font-size: 9px; color: #666; font-weight: normal">(Click to remove)</span>',
				style:
				{
					fontStyle: 'italic'
				}
			},
			enabled: true,
			align: 'right',
			verticalAlign: 'top',
			layout: 'vertical',
			y: 50,
			x: 10
		},

		//x-axis configuration
		xAxis:
		{
			minPadding: 0,
			maxPadding: 0,
			
			title: { text: timezone },
			
			//x axis labels
			categories:
			[{
				name: dayName[0],
				categories: zero
			},
			
			{
				name: dayName[1],
				categories: one
			},
			
			{
				name: dayName[2],
				categories: two
			},
			
			{
				name: dayName[3],
				categories: three
			},
			
			{
				name: dayName[4],
				categories: four
			},
			
			{
				name: dayName[5],
				categories: five
			},
		
			{
				name: dayName[6],
				categories: six
			},

			{
				name: dayName[7],
				categories: seven
			}],
			
			//x axis label configuration
			labels:
			{
				rotation: 0,
				style: { fontSize: '11px' },
			},
		},
		

		//Y axis configuration
		yAxis:
		{
			gridLineDashStyle: 'longdash',
			gridLineColor: 'black',
			minPadding: 0,
			maxPadding: 0,
			
			//Title of y-axis
			title: { text: yaxislabel },

			//Plot band configuration
			plotBands:
			[{
				//Green (low risk) plot band
				from: plotBandLowerBoundary,
				to: plotBandYellowGreenBoundary,
				color: green,
				//Green plot band title configuration
				label:
				{
					text: 'LOW RISK',
					align: 'center',
					style:
					{
						color: 'black',
						fontSize: '18px',
						fontWeight: 'bold'
					}
				}
			},

			{
				//Yellow (moderate risk) plot band
				from: plotBandYellowGreenBoundary,
				to: plotBandRedYellowBoundary,
				color: yellow,
				
				//Yellow plot band title configuration
				label:
				{
					text: 'MODERATE RISK',
					align: 'center',
					style:
					{
						color: 'black',
						fontSize: '18px',
						fontWeight: 'bold'
					}
				}
			},

			{
				//Red (high risk) plot band
				from: plotBandRedYellowBoundary,
				to: plotBandUpperBoundary,
				color: red,
				
				//Red plot band title configuration
				label:
				{
					text: 'HIGH RISK',
					align: 'center',
					style:
					{
						color: 'black',
						fontSize: '18px',
						fontWeight: 'bold'
					}
				}
			}]
		},
	
		//Tooltip Configuration
		tooltip:
		{
			//animation: false,
			//enabled: false,
			useHTML: true,
			//crosshair: [true, true],
			//shared: false,
			//snap: 40,
			stickyTracking: false,
			borderWidth: 0,
			//padding: 5,
			//z: 20,
			style: { padding: 0 },

			//Tooltip Formatter
			formatter: function()
			{
				wind = [];
				concreteTemp = [];
				
				//var newSeries = this.series;
				//var index = $.inArray(this.x, labelDate);
				var index = this.point.series.xData.indexOf(this.point.x);
				
				//Sets border color of tooltip
				//If evap rate is over .2 then Red tooltip border
				if (this.y > ModerateRiskBoundary) { tmpColor = red; }
				
				//yellow border
				else if (this.y > lowRiskBoundary && this.y <= ModerateRiskBoundary) { tmpColor = yellow; }
				
				//Green border
				else { tmpColor = green; }
				
				if (this.series.name == 'Original Prediction')
				{
					wind = windSpeedArray;
					concreteTemp = concTempArray;
				}
				
				else if (this.series.name == 'Inside')
				{
					wind = insideWindSpeed;
					concreteTemp = concTempArray;
				}
				
				else if (this.series.name.length >= 26)
				{
					str = this.series.name
					
					if (isMetric)
					{
						newConcreteTemp = parseFloat(str.match(/[\d\.]+/));
					}
					
					else
					{
					newConcreteTemp = str.match(/\d/g);
					newConcreteTemp = newConcreteTemp.join("");
					}

					//Inside
					if (str.indexOf("Inside") > -1)
					{
						for (var i=0; i <arrayLength; i++)
						{
							concreteTemp[i] = newConcreteTemp;
							wind[i] = insideWindSpeed[i];
						}
					}
					
					//Outside
					else
					{
						for (var i=0; i <arrayLength; i++)
						{
							concreteTemp[i] = newConcreteTemp;
							wind[i] = windSpeedArray[i];
						}
					}	
				}
				
				var s = '<div style= "padding: 10px; border: 3px solid '+tmpColor+';">';
				s +='<b>'+ fullDate[index] +'</b>';
				s += '<br/> <b> Evaporation Rate: ' + main.round(this.y, 2) + evaporationRateLabel;
				s += '<br/>	\u2022 Temperature: ' + main.round(airTempArray[index], 2) + temperatureLabel;
				s += '<br/> \u2022 Concrete Temperature: ' + main.round(concreteTemp[index], 2) + temperatureLabel;
				s += '<br/>	\u2022 Wind: ' + main.round(wind[index], 2) + windLabel;
				s += '<br/>	\u2022 Relative Humidity: ' + humidityArray[index]+ '%';
				s += '<br/>	\u2022 Cloud Cover: ' + cloudCoverArray[index] +'%';
				
				// If standard
				if (isMetric == false)
				{
					//If evaporation rate has a high risk show concrete temperature to go from the high to moderate risk and from high to low risk
					if (this.y > ModerateRiskBoundary)
					{
						suggestedLowConcTemp = main.getLowerRiskTemp(lowRiskBoundary, wind[index], humidityArray[index], airTempArray[index] );						
						suggestedModConcTemp = main.getLowerRiskTemp(ModerateRiskBoundary, wind[index], humidityArray[index], airTempArray[index] );
						s+= '<br/> \u2022 Concrete temp needed for moderate risk: ' + main.round(suggestedModConcTemp, 2) + temperatureLabel;
						s+= '<br/> \u2022 Concrete temp needed for low risk: ' + main.round(suggestedLowConcTemp, 2) + temperatureLabel;
					}

					//If evaporationg rate has a moderate risk
					else if (this.y > lowRiskBoundary)
					{
						suggestedLowConcTemp = main.getLowerRiskTemp(lowRiskBoundary, wind[index], humidityArray[index], airTempArray[index] );	
						s+= '<br/> \u2022 Concrete temp needed for low risk: ' + main.round(suggestedLowConcTemp, 2) + temperatureLabel;
					}
					
					//Add hot/cold weather warnings
					if (concreteTemp[index] <= coldWeatherConcTemp)
					{
						s+= ' <br/> <div style = "color:red">Warning: Ambient temperatures require cold weather placement <br>techniques, see ACI 306 Guide to Cold Weather Concreting<div>';
					}
					
					else if (concreteTemp[index] >= hotWeatherConcTemp)
					{
						s+= ' <br/> <div style = "color:red">Warning: Ambient temperatures require hot weather placement <br>techniques, see ACI 305 Guide to Hot Weather Concreting<div>';
					}
				}//end if

				//else metric
				else
				{
					//If evaporation rate has a high risk
					if (this.y > ModerateRiskBoundary)
					{
						suggestedLowConcTemp = main.convertFtoC(main.getLowerRiskTemp(lowRiskBoundary, main.convertKphToMph(wind[index]), humidityArray[index], main.convertCtoF(airTempArray[index])));
						suggestedModConcTemp = main.convertFtoC(main.getLowerRiskTemp(ModerateRiskBoundary, main.convertKphToMph(wind[index]), humidityArray[index], main.convertCtoF(airTempArray[index])));			
						s+= '<br/> \u2022 Concrete temp needed for moderate risk: ' + main.round(suggestedModConcTemp, 2) + temperatureLabel;
						s+= '<br/> \u2022 Concrete temp needed for low risk:' + main.round(suggestedLowConcTemp, 2) + temperatureLabel;
					}

					//If evaporation rate has a moderate risk
					else if(this.y > lowRiskBoundary )
					{
						suggestedLowConcTemp = main.convertFtoC(main.getLowerRiskTemp(lowRiskBoundary, main.convertKphToMph(wind[index]), humidityArray[index], main.convertCtoF(airTempArray[index])));
						s+= '<br/> \u2022 Concrete temp needed for low risk: ' + main.round(suggestedLowConcTemp, 2) + temperatureLabel;
					}
					
					//Add hot/cold weather warnings
					if (main.convertCtoF(concreteTemp[index]) <= coldWeatherConcTemp)
					{
						s+= ' <br/> <div style = "color:red">Warning: Ambient temperatures require cold weather placement <br>techniques, see ACI 306 Guide to Cold Weather Concreting<div>';
					}
					
					else if (main.convertCtoF(concreteTemp[index]) >= hotWeatherConcTemp)
					{
						s+= ' <br/> <div style = "color:red">Warning: Ambient temperatures require hot weather placement <br>techniques, see ACI 305 Guide to Hot Weather Concreting<div>';
					}
				}//end else metric
				
				//return tooltip string
				s+= '</div>';
				return s;
			}, //End tooltip formatter
		}, //End Tooltip
		
		//Plot Configuration
		plotOptions:
		{
			//Series Configurations
			series:
			{
				color: 'black',
				
				cursor: 'pointer',
				allowPointSelect: true,
				selected: true,
				marker: {
					enabled: true,
					
				},
				events:
				{
					hide: function()
					{
						this.show();
						
						if (this.name == 'Original Prediction')
						{
							alert('Can not delete Original Prediction');
						}
						else
						{
							//If a project delete from the database and remove from graph
							if (isProject)
							{
								$.ajax({
									url: '/php/removeSeries.php',
									type: 'post',
									data: {sID: this.options.id},
									
									success: function(response)
									{
										
									}
									});
							}
							//Else just remove the series
							else { this.remove(); }
							this.remove();
						}
						
						
					},
				},
				
				point:
				{
					events:
					{
						mouseout: function() { this.chart.tooltip.hide(); },
						
						click: function()
						{
							if (isProject)
							{
								if (isOwner == true)
								{
									
									//c =$('#container').highcharts();
									notifTimeID = timeArray[this.x];
									seriesNotifID = this.series.options.id;
									document.getElementById("notiftitle").innerHTML = 'Add Notification for '+ fullDate[this.x];
							
									if (this.y <= 0.15)
									{
										currentZone = 0;
										document.getElementById("notif1").innerHTML = 'Moderate Risk';
										document.getElementById("notif2").innerHTML = 'High Risk';
										document.getElementById("notif3").innerHTML = 'Moderate or High Risk';
									}
							
									else if (this.y <= 0.20)
									{
										currentZone = 1;
										document.getElementById("notif1").innerHTML = 'Low Risk';
										document.getElementById("notif2").innerHTML = 'High Risk';
										document.getElementById("notif3").innerHTML = 'Low or High Risk';
									}
							
									else
									{
										currentZone = 2;
										document.getElementById("notif1").innerHTML = 'Low Risk';
										document.getElementById("notif2").innerHTML = 'Moderate Risk';
										document.getElementById("notif3").innerHTML = 'Low or Moderate Risk';
									}
									
									
									if (this.color === undefined)
									{
										$(document).ready(function(){
										$("#notificationModal").modal('show');});
									}
									
									else if (this.color == 'green')
									{
										
										//current zone = Low Risk
										if (currentZone == 0)
										{
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';
											
											document.getElementById("editNotif1").innerHTML = 'Moderate Risk';
											document.getElementById("editNotif2").innerHTML = 'High Risk';
											document.getElementById("editNotif3").innerHTML = 'Moderate or High Risk';
										}
										
										//current zone = Moderate Risk
										else if (currentZone == 1)
										{
											document.getElementById("editNotif1").innerHTML = 'High Risk';
											document.getElementById("editNotif1").innerHTML = 'Low or High Risk';
										}
										//current zone = High Risk
										else if (currentZone == 2)
										{
											document.getElementById("editNotif1").innerHTML = 'Moderate Risk';
											document.getElementById("editNotif2").innerHTML = 'Low or Moderate Risk';
										}
										
										$(document).ready(function(){
										$("#editNotificationModal").modal('show');});
									}
									
									else if (this.color == 'red')
									{
																				
										//current zone = Low Risk
										if (currentZone == 0)									
										{											
											document.getElementById("editNotif1").innerHTML = 'Moderate Risk';
											document.getElementById("editNotif2").innerHTML = 'Moderate or High Risk';
										
										}
										//current zone = Moderate Risk
										else if (currentZone == 1)
										{
											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											document.getElementById("editNotif2").innerHTML = 'Low or High Risk';
										}
										
										//current zone = High Risk
										else if (currentZone == 2)
										{
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';
											
											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											document.getElementById("editNotif2").innerHTML = 'Moderate Risk';
											document.getElementById("editNotif3").innerHTML = 'Low or Moderate Risk';
											
										}
										
										$(document).ready(function(){
										$("#editNotificationModal").modal('show');});
									}
									
									else if (this.color == 'yellow')
									{
																				
										//current zone = Low Risk
										if (currentZone == 0)									
										{											
											
											
											document.getElementById("editNotif1").innerHTML = 'High Risk';
											
											document.getElementById("editNotif2").innerHTML = 'Moderate or High Risk';
											
										
										}
										//current zone = Moderate Risk
										else if (currentZone == 1)
										{
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';

											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											
											document.getElementById("editNotif2").innerHTML = 'High Risk';

											document.getElementById("editNotif3").innerHTML = 'Low or High Risk';
										}
										
										//current zone = High Risk
										else if (currentZone == 2)
										{
											
											document.getElementById("editNotif1").innerHTML = 'Low Risk';
										
											document.getElementById("editNotif2").innerHTML = 'Low or Moderate Risk';
											
										}
										
										$(document).ready(function(){
										$("#editNotificationModal").modal('show');});
									}
									
									else if (this.color == 'orange')
									{
										//current zone = Low Risk
										if (currentZone == 0)									
										{											
											
											document.getElementById("editNotif1").innerHTML = 'Moderate Risk';
											document.getElementById("editNotif2").innerHTML = 'High Risk';
											
										
										}
										//current zone = Moderate Risk
										else if (currentZone == 1)
										{
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';

											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											
											document.getElementById("editNotif2").innerHTML = 'High Risk';
											
											
											document.getElementById("editNotif3").innerHTML = 'Low or High Risk';
										}
										
										//current zone = High Risk
										else if (currentZone == 2)
										{
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';
											
											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											document.getElementById("editNotif2").innerHTML = 'Moderate Risk';
											
											document.getElementById("editNotif3").innerHTML = 'Low or Moderate Risk';
											
											
										}
										$(document).ready(function(){
										$("#editNotificationModal").modal('show');});
									}
									
									else if (this.color = 'brown')
									{
										//current zone = Low Risk
										if (currentZone == 0)									
										{											
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';
					
											document.getElementById("editNotif1").innerHTML = 'Moderate Risk';
											document.getElementById("editNotif2").innerHTML = 'High Risk';
											
											document.getElementById("editNotif3").innerHTML = 'Moderate or High Risk';
											
										
										}
										//current zone = Moderate Risk
										else if (currentZone == 1)
										{
											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											
											document.getElementById("editNotif2").innerHTML = 'High Risk';
											
											
										}
										
										//current zone = High Risk
										else if (currentZone == 2)
										{
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';
											
											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											document.getElementById("editNotif2").innerHTML = 'Moderate Risk';
											
											document.getElementById("editNotif3").innerHTML = 'Low or Moderate Risk';
										
											
										}
										$(document).ready(function(){
										$("#editNotificationModal").modal('show');});
									}
									
									else
									{
										//current zone = Low Risk
										if (currentZone == 0)									
										{											
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';
							
											document.getElementById("editNotif1").innerHTML = 'Moderate Risk';
											document.getElementById("editNotif2").innerHTML = 'High Risk';
											document.getElementById("editNotif3").innerHTML = 'Moderate or High Risk';
											
										
										}
										//current zone = Moderate Risk
										else if (currentZone == 1)
										{
											document.getElementById("notifHasBeenMetAlert").innerHTML = 'The current predicted risk meets your notification reuqirements. Your e-mail notification will be sent later if the current predicted risk remains the same.';

											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											
											document.getElementById("editNotif2").innerHTML = 'High Risk';
											
											
											document.getElementById("editNotif3").innerHTML = 'Low or High Risk';
										}
										
										//current zone = High Risk
										else if (currentZone == 2)
										{
											
											document.getElementById("editNotif1").innerHTML = 'Low Risk';
											document.getElementById("editNotif2").innerHTML = 'Moderate Risk';
											
										}
										$(document).ready(function(){
										$("#editNotificationModal").modal('show');});
									}
								
									
								}
								
								else
								{
									alert('Must be project owner to add a notification.')
								}
							}
						}//end click event
					}
				}//end point
			},//end series
		},//end plot options

		//Credits disabled
		credits: { enabled: false },

		//Data - Evaporation rates for times
		series:
		[{
			name: 'Original Prediction',
			data: evapArray,
			lineWidth: 2,
			//color: 'black',
			//lineColor: 'red',
			id: 'original'
		}],

		lang:
		{
			download_key: 'Click here to download the graph',
			email_key: 'Click here to email the graph',
			print_key: 'Click here to print the graph',
			add_series_key: 'Clck here to add a new series to the graph'
		},
		
		navigation:
		{
			buttonOptions:
			{
				theme:
				{
					'stroke-width': 1,
					stroke: 'silver',
					states:
					{
						hover: { },
						select: { stroke: '#039', }
					}
				}
			},
		}, //end navigation
		
		//Exporting options. Added "Options" text next to export button.
		exporting:
		{
			sourceWidth: 1510,
			sourceHeight: 770,
			buttons:
			{
				contextButton: { enabled: false },
				
				//Download Graph Button
				exportButton:
				{
					text: 'Download',
					_titleKey: 'download_key',
					x: -167,
					y: yLevel,
					menuItems: Highcharts.getOptions().exporting.buttons.contextButton.menuItems.splice(2)
				},
				
				//Print Graph Button
				printButton:
				{
					text: 'Print Graph',
					_titleKey: 'print_key',
					x: -240,
					y: yLevel,
					onclick: function () { this.print(); }
				},
				
				//Email Graph Button
				emailButton:
				{
					text: 'Email Graph',
					_titleKey: 'email_key',
					x: -321,
					y: yLevel,
						onclick: function ()
						{
							$(document).ready(function(){
							$("#emailModal").modal('show');});
						}
				},
				
				//Add Series Button
				AddSeriesButton:
				{
					text: 'Modify Conditions',
					_titleKey: 'add_series_key',
					x: -406,
					y: yLevel,
						onclick: function ()
						{
							$(document).ready(function(){
							$("#weatherChangeModal").modal('show');});
						}
				}
			}
		} //end exporting
	}); //end chart config

	$("#ResetButton").click(function()
	{
		var chartN = $('#container').highcharts();
		chartN.redraw();
		for (var ii = 0; ii < arrayLength; ii++)
		{
			evapArray[ii] = originalEvapArray[ii];
			concTempArray[ii] = originalConcTempArray[ii];
			windSpeedArray[ii] = originalWindSpeedArray[ii];
			//Update chart
			//chartN.series[0].data[ii].update(evapArray[ii]);
			//chartN.series[0].update(chartN.series[0].data[ii].options);
			//chart.tooltip.refresh(chart.series[0].points[ii]);
		}
		//chart.series[0].setData(originalEvapArray)
		chartN.redraw();
		isOriginalGraph = true;
	});
	
	$("#sbutton").click(function()
	{
		$('#weatherChangeModal').modal('hide');
		cTemp = document.getElementById("concreteTemp").value;
		
		if (isMetric)
		{
			if (cTemp != '') { cTemp = parseFloat(cTemp).toFixed(2); }	
		}
		
		else
		{
			if (cTemp != '')
			{
				//TODO handle if ctemp = 0 and in standard
				cTemp = parseInt(cTemp);
			}
		}
	
		windS = document.getElementById("windSpeed").value;
		
		if (cTemp < lowerBoundConcreteTemp && cTemp != '')
		{
			alert('Concrete temperature must be higher than '+ lowerBoundConcreteTemp + temperatureLabel);
		}
		
		else if (cTemp > upperBoundConcreteTemp && cTemp != '')
		{
			alert('Concrete temperature must be lower than than '+ upperBoundConcreteTemp + temperatureLabel);
		}
		
		//Check for same series if its a project
		else if (isProject)
		{
			$.ajax({
				url: '/php/check.php',
				type: 'post',
				data: {pID: projectID,
				isOriginal: 'n',
				concrete: cTemp,
				wind: windS},
				
				success: function(response)
				{
					if (response != 'success')
					{
						alert(response);
					}
					else
					{
						AddSeries(cTemp, windS);
					}
				}
			});
		}
			
		else
		{
			AddSeries(cTemp, windS);	
		}
		return false;
	});//end sbutton click
	
	$("#checkbox").click(function() { $("#notifInfo").hide(); });
	
	$("#addNotif").click(function()
	{
		var c = $('#container').highcharts();
		var notif = document.getElementById("notif").value;

	
		//0=low; 1=med; 2=high; 3=low/med; 4=med/high ;5=low/high
		
		if (notif == 'Low Risk') { notif = 0; }
		else if (notif == 'Moderate Risk') { notif = 1; }
		else if (notif == 'High Risk') { notif = 2; }
		else if (notif == 'Low or Moderate Risk') { notif = 3; }
		else if (notif == 'Moderate or High Risk') { notif = 4; }
		else if (notif == 'Low or High Risk') { notif = 5; }

		
		$.ajax({
			url: '/php/addNotif.php',
			type: 'post',
			data: {zWanted: notif,
				zCurrent: currentZone,
				time: notifTimeID,
				pID: projectID,
				sID: seriesNotifID},
			
			success: function(response)
			{
				if (response != 'success')
				{
					alert(response);
				}
				else
				{
					$("#notifSuccess").show();
					$('#notificationModal').modal('toggle');
					
					
					
					
				}
			}
		});

	});
	
	$( document ).ready(function()
	{
		//If project
		if (isProject == true)
		{
			$.ajax({
				url: '/php/getSeries.php',
				data: {pID: projectID},
			
				type: 'post',
				
				success: function(response)
				{
					if (response != 'None')
					{
						
						var obj = JSON.parse(response)
						var sid = obj.id;
						var concrete = obj.concrete;
						var wind = obj.wind;
						var addtoChart = $('#container').highcharts();
						var chart = $('#container').highcharts();

						for (i =0; i <sid.length; i++)
						{
							var name ='';
							var tmpConcrete = '';
							var tmpWind = '';
							var tmpEvapArray = [];
							var tmpColor = main.getColor(i);
							
							//IF CONCRETE = 0 use default prediciton
							//IF WIND = 0 use default prediciton
							if (concrete[i] == 0 && wind[i] == 1)
							{
								name = 'Inside';
								for (j = 0; j < arrayLength; j++)
								{
									tmpEvapArray[j] = main.calculateEvap(airTempArray[j], humidityArray[j], insideWindSpeed[j], concTempArray[j]);
								}
								chart.addSeries({
									name: name,
									data: tmpEvapArray,
									color: tmpColor,
									marker: { symbol: 'circle' },
									id: sid[i],
									dashStyle: 'dot',
									lineWidth: 2
								}, false);
							}
							
							else if (concrete[i] !=0 && wind[i] == 0)
							{
								name = 'Concrete temp ' + concrete[i] + ' ' + temperatureLabel + '<br>Outside Wind Speed';
								for (j = 0; j < arrayLength; j++)
								{
									tmpEvapArray[j] = main.calculateEvap(airTempArray[j], humidityArray[j], windSpeedArray[j], concrete[i]);
								}
			
								chart.addSeries({
									name: name,
									data: tmpEvapArray,
									color: tmpColor,
									id: sid[i],
									marker: { symbol: 'circle' },
									dashStyle: 'dot',
									lineWidth: 2
									}, false);
							}
							
							else if (concrete[i] !=0 && wind[i] == 1)
							{
								name = 'Concrete temp ' + concrete[i] + ' ' + temperatureLabel + '<br>Inside';
								for (j = 0; j < arrayLength; j++)
								{
									tmpEvapArray[j] = main.calculateEvap(airTempArray[j], humidityArray[j], insideWindSpeed[j], concrete[i]);
								}
			
								chart.addSeries({
									name: name,
									data: tmpEvapArray,
									color: tmpColor,
									marker: { symbol: 'circle' },
									id: sid[i],
									dashStyle: 'dot',
									lineWidth: 2
									}, false);
							}
							chart.redraw();
							numberOfSeries = numberOfSeries + 1;
						}
					}
				}
			});
			
			$.ajax({
				url: '/php/getNotif.php',
				data: {pID: projectID},
				type: 'post',
				
				success: function(response)
				{
					if (response != 'None')
					{
						//var obj = JSON.parse(response)
						//alert(response);
						var obj = JSON.parse(response)
						var changeInStateID = obj.changeInStateID;
						var idOfSeries = obj.sid;
						var time = obj.time;
						var cZone = obj.currentZone;
						var notifyZone = obj.notifyZone;
						var chart = $('#container').highcharts();
						var numbOfSeries;

						indexArr = [];
						//alert(changeInStateID.length);
						
						//find how many series there are
						var counter = 0;
						while (chart.series[counter] != undefined)
						{
							counter = counter + 1;
						}
						//alert(counter);
					//	alert(chart.series[1].options.id);
						
						//Loop through all the series
						for(y=0; y < counter; y++)
						{
							//Loop through the notificaitons
							for (x = 0; x < changeInStateID.length; x++)
							{
								//seriesID = seriesID of changeinrisk notification
								if (chart.series[y].options.id == idOfSeries[x])
								{
									//loop through all the points
									$.each(chart.series[y].data,function(i,data)
									{
									
										//If equal get index of point
										if (time[x] == timeArray[i])
										{
											
											//set colors
											//0=low; 1=med; 2=high; 3=low/med; 4=med/high ;5=low/high

											if (notifyZone[x] == 0) {
												notifyColor = 'green';
											}
											
											else if (notifyZone[x] == 1) {
												notifyColor = 'yellow';
											}
											
											else if (notifyZone[x] == 2) {
												notifyColor = 'red';
											}
											
											else if (notifyZone[x] == 3) {
												notifyColor = '#90EE90';
											}
											
											else if (notifyZone[x] == 4) {
												notifyColor = 'orange';
											}
											
											else{
												notifyColor = 'brown';
											}
											//alert(i);
											//If index of point = index
												
													//alert (data.category);
											data.update({
												color: notifyColor,
												radius: 5
							
												});
												
											
										}
									});
								}
							}
						}


					}
				}
				});
		}
	});
	

	$('.alert .close').on('click', function(e) { $(this).parent().hide(); });

	$("#emailGraph").click(function()
	{
		var c = $('#container').highcharts();
		var email = document.getElementById("email").value;
		name = document.getElementById("name").value;
		var message = document.getElementById("message").value;
		var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
		
		//validate email
		if (email == '' || emailReg.test(email) == false) { alert('Invalid e-mail address'); }
		else if (name == '') { alert('Please enter your name'); }
		//else send email
		else
		{
			var url = window.location.href;
			$("#emailSuccess").show();
			$('#emailModal').modal('toggle');
		}
	});

	function AddSeries(cTemp, windS)
	{
		seriesName = '';
		newEvapArray = [];
		seriesColor = main.getColor(numberOfSeries);
		var chart = $('#container').highcharts();
			
		//If only outside and default concrete temp
		if (windS == 'Outside' && cTemp == '') { alert("Series already exists");}
		
		// if inside and default concrete temp
		else if (windS == 'Inside' && cTemp == '')
		{
			
				//numberOfSeries = numberOfSeries + 1;
				seriesName = 'Inside';
				
				for (i = 0; i < arrayLength; i++)
				{
					newEvapArray[i] = main.calculateEvap(airTempArray[i], humidityArray[i], insideWindSpeed[i], concTempArray[i]);
				}
						
				if (isProject)
				{
					if (cTemp == '') { cTemp = 'null'; }
					//alert(projectID);
					$.ajax({
						url: '/php/addSeries.php',
						type: 'post',
						data: {pID: projectID,
						isOriginal: 'n',
						concrete: cTemp,
						wind: windS},
					
						success: function(seriesID)
						{
							//alert (seriesID);
							if (seriesID != '')
							{
								chart.addSeries({
									name: seriesName,
									data: newEvapArray,
									color: seriesColor,
									marker: { symbol: 'circle' },
									id: seriesID,
									dashStyle: 'dot',
									lineWidth: 2
								}, false);
								chart.redraw();
							}
						}
					});
				}
					
				else
				{
					chart.addSeries({
						name: seriesName,
						data: newEvapArray,
						color: seriesColor,
						marker: { symbol: 'circle' },
						dashStyle: 'dot',
						lineWidth: 2
					}, false);
					chart.redraw();
				}
		} //end if inside and defualt concrete temp
		
		//Outside and new Concrete Temp
		else if(windS == 'Outside' && cTemp != '')
		{
			//numberOfSeries = numberOfSeries + 1;
			seriesName = 'Concrete temp ' + cTemp + ' ' + temperatureLabel + '<br>Outside Wind Speed';
			
			for (i = 0; i < arrayLength; i++)
			{
				newEvapArray[i] = main.calculateEvap(airTempArray[i], humidityArray[i], windSpeedArray[i], cTemp);
			}
				
			//If project
			if (isProject)
			{
				if (cTemp == '') { cTemp = 'null'; }
			
				$.ajax({
					url: '/php/addSeries.php',
					type: 'post',
					data: {pID: projectID,
					isOriginal: 'n',
					concrete: cTemp,
					wind: windS},
					
					success: function(seriesID)
					{
						if (seriesID != '')
						{
							chart.addSeries({
								name: seriesName,
								data: newEvapArray,
								color: seriesColor,
								marker: { symbol: 'circle' },
								id: seriesID,
								dashStyle: 'dot',
								lineWidth: 2
							}, false);
							chart.redraw();
						}
					}
				});
			}
					
			else
			{	
				chart.addSeries({
					name: seriesName,
					data: newEvapArray,
					marker: { symbol: 'circle' },
					symbol: 'circle',
					dashStyle: 'dot',
					lineWidth: 2
				}, false);
				chart.redraw();
			}	
		}//end outside and new concrete temp
			
		//Inside and new concrete temp
		else if (windS == 'Inside' && cTemp != '')
		{
				//numberOfSeries = numberOfSeries + 1;
				seriesName = 'Concrete temp ' + cTemp + ' ' + temperatureLabel + '<br>Inside';
				cTempOffset = cTemp.length
				windOffset = 1;
				
				for (i = 0; i < arrayLength; i++)
				{
					newEvapArray[i] = main.calculateEvap(airTempArray[i], humidityArray[i], insideWindSpeed[i], cTemp);	
				}
					
				if (isProject)
				{
					if (cTemp == '') { cTemp = 'null'; }
				
					$.ajax({
						url: '/php/addSeries.php',
						type: 'post',
						data: {pID: projectID,
						isOriginal: 'n',
						concrete: cTemp,
						wind: windS},
					
						success: function(seriesID)
						{
							if (seriesID != '')
							{
								chart.addSeries({
									name: seriesName,
									data: newEvapArray,
									color: seriesColor,
									marker: { symbol: 'circle' },
									id: seriesID,
									dashStyle: 'dot',
									lineWidth: 2
								}, false);
								chart.redraw();
							}
						}
					});
				}
					
				else
				{
					chart.addSeries({
						name: seriesName,
						data: newEvapArray,
						marker: { symbol: 'circle' },
						color: seriesColor,
						dashStyle: 'dot',
						lineWidth: 2
					}, false);
					chart.redraw();
				}
		}//end Inside and new concrete
		numberOfSeries = numberOfSeries + 1;
	}


});//End function







</script>



<div id ="button"></div>

<div id="emailModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Email Graph</h4>
			</div>
			<div class="modal-body">
				<form onsubmit="return false;">
					<input class="form-control" id="email" type="text" placeholder='E-mail Address' required>
					<input class="form-control" id="name" type="text" placeholder='Name' required>

						<textarea name = "message" id = 'message' class="form-control" placeholder="Add message...." ></textarea>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id='emailGraph'>Send E-mail</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
				</form>
		</div>
	</div>
</div>

<div id="notificationModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="a" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id = notiftitle>Add Notification</h4>
			</div>
			<div class="modal-body">
				<form>
					Receive an e-mail when the predicted risk changes to
					<select id='notif'>
						<option id = notif1> </option>
						<option id = notif2> </option>
						<option id = notif3> </option>
					</select>
			</div>
			<div class = "modal-footer">
				<button type="button" class="btn btn-primary" id="addNotif" >Add Notification</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</form>
			</div>
		</div>
	</div>
</div>

<div id="editNotificationModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="a" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id = notiftitle>Edit/Delete Notification</h4>
			</div>
			<span id = "notifHasBeenMetAlert"> </span>
			<div class="modal-body">
				<form>
					Change Notification to: 
					<select id='notif'>
						<option id = editNotif1> </option>
						<option id = editNotif2> </option>
						<option id = editNotif3> </option>

					</select>
					
			</div>
			<div class = "modal-footer">
				<button type="button" class="btn btn-danger pull-left" id="editNotif" >Delete Notification</button>
				<button type="button" class="btn btn-primary" id="editNotif" >Change Notification</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="weatherChangeModal">
	<div class="modal-dialog modal-sm">
		<div class="modal-content container-fluid">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="newProjectLabel">Add series</h4>
				Create a new series with a custom concrete temperature/wind speed for the entire series.
			</div>
			<form class="form-horizontal" id="weatherChangeForm" action=none>
				<div class="modal-body">
					<div class="row">
						<div class="col-xs-12">
							<div class="form-group">
								<label for="concreteTemp" class="control-label">Concrete Temperature</label>
								<div class='input-group'>
									<input type="number" class="form-control" id="concreteTemp" maxlength="3" placeholder="Default" title="If blank it defaults to orginal predicted concrete temperature.">
									<span id="cTempLabel" class="input-group-addon"></span>
								</div>
							</div>
						</div>
						<div class="col-xs-12">
							<div class="form-group">
								<label for="windSpeed" class="control-label">Wind Speed</label>
								<select id="windSpeed" class="form-control" title="If placing concrete inside change to Inside.">
									<option id="Outside">Outside</option>
									<option id="Inside">Inside</option>
								</select>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<div class="row">
						<div class="col-xs-7" align="left">
							<button type="button" class="btn btn-primary" id="sbutton">Submit</button>
						</div>
						<div class="col-xs-5" align="right">
							<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>


